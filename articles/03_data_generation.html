<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data generation • FluxDataKit</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,300;0,400;0,700;1,300;1,400&amp;display=swap" rel="stylesheet">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- geco --><link href="../geco.css" rel="stylesheet">
<meta property="og:title" content="Data generation">
<meta property="og:description" content="FluxDataKit">
<meta name="twitter:card" content="summary">
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">

    <div class="navbar-header">

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="external-link hidden-sm hidden-xs" href="https://geco-group.org/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_white_small.png" id="hexlogo" alt="GECO"></a>
        <a class="external-link hidden-md hidden-lg" href="https://geco-group.org/">
          <img src="https://raw.githubusercontent.com/computationales/GECO_template/main/geco_logo_white_small.png" id="hexlogo" alt="GECO"></a>
        <a class="navbar-brand" href="../index.html">
           <i>FluxDataKit <small>v0.9</small></i>
        </a>
      </div>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01_setup.html">Setup and data provenance</a>
    </li>
    <li>
      <a href="../articles/02_data_coverage.html">Data coverage</a>
    </li>
    <li>
      <a href="../articles/03_data_generation.html">Data generation</a>
    </li>
  </ul>
</li>
        
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Data generation</h1>
                        <h4 data-toc-skip class="author">Koen
Hufkens</h4>
            
      
      
      <div class="hidden name"><code>03_data_generation.Rmd</code></div>

    </div>

    
    
<blockquote>
<p>Note this routine will only run with the appropriate files in the
correct place. Given the file sizes involved no demo data can be
integrated into the package.</p>
</blockquote>
<div class="section level2">
<h2 id="compiling-data">Compiling data<a class="anchor" aria-label="anchor" href="#compiling-data"></a>
</h2>
<p>As mentioned in the introduction (once all required data are
downloaded) the <code>FluxDataKit</code> package ensures the proper
compilation of <code>rsofun</code> driver data. Although we will
distribute a finished dataset the below instructions allow you to
recreate these data for a particular site (or sites).</p>
<p>To generate consistent data from FLUXNET formatted sources we need a
site list with some additional meta-data. A site list is generated using
the script as described in the ‘data coverage’ vignette. We refer to
this vignette to compile the list of sites which can be processed.</p>
<p>Once a site list has been compiled you can use it (and all the other
input data) to generated either land surface model or
<code>rsofun</code> compatible datasets. Here, the former is used as a
precursor to the latter.</p>
<div class="section level3">
<h3 id="lsm-formatting">LSM formatting<a class="anchor" aria-label="anchor" href="#lsm-formatting"></a>
</h3>
<p>By default land surface model compatible data is generated using the
FluxnetLSM package. Retaining only this data can be done by specifying
the <code>format</code> parameter, and setting it to “lsm”. This routine
will only save the netcdf intermediates that are otherwise used for
formatting p-model compatible data and will not include any other
ancillary data.</p>
<blockquote>
<p>Meta-data requirements: Note that the sites file can be generated by
other means than the included script. It only has to contain the
following values: A site name (<code>sitename</code>), latitude and
longitude (<code>lat</code>, <code>lon</code>), elevation
(<code>elv</code>), the start and end date of the dataset
(<code>date_start</code> / <code>date_end</code>), the original product
and data path (<code>product</code> and <code>data_path</code>
respectivelly, which are combined into the formal data directory), a
start and end year (<code>year_start</code>, <code>year_end</code>), the
Koeppen Geiger code for a site (<code>koeppen_code_beck</code>), the
water holding capacity (<code>whc</code>), and the IGBP land cover class
(<code>igbp_land_use</code>). Routines specified in the processing
scripts are there to make it easy to gather these data but users are
free to compile additional data for their own use. The above fields are
however required.</p>
</blockquote>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load the sites to process</span></span>
<span><span class="co"># as generated from scripts in `data-raw` (see github repo)</span></span>
<span><span class="va">sites</span> <span class="op">&lt;-</span> <span class="fu">FluxDataKit</span><span class="fu">::</span><span class="va"><a href="../reference/fdk_site_info.html">fdk_site_info</a></span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">sitename</span> <span class="op">==</span> <span class="st">"FR-Fon"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    data_path <span class="op">=</span> <span class="st">"/data/scratch/FDK_inputs/flux_data"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># output LSM formatted data</span></span>
<span><span class="fu"><a href="../reference/fdk_process_lsm.html">fdk_process_lsm</a></span><span class="op">(</span></span>
<span>  <span class="va">sites</span>,</span>
<span>  out_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  modis_path <span class="op">=</span> <span class="st">"/data/scratch/FDK_inputs/modis"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># list generated files</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/utils/glob2rx.html" class="external-link">glob2rx</a></span><span class="op">(</span><span class="st">"*FR-Fon*.nc"</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fluxnet-formatting">FLUXNET formatting<a class="anchor" aria-label="anchor" href="#fluxnet-formatting"></a>
</h3>
<p>By default the format parameter is set to “lsm”, providing land
surface model netcdf files as output. You can specify “fluxnet” to
convert the data to <code>rsofun</code> compatible FLXUNET output.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># read in demo data</span></span>
<span><span class="co"># for FR-Fon site (as LSM data)</span></span>
<span><span class="co"># convert to the HH fluxnet format</span></span>
<span><span class="va">fluxnet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fdk_convert_lsm.html">fdk_convert_lsm</a></span><span class="op">(</span></span>
<span>  site <span class="op">=</span> <span class="st">"FR-Fon"</span>,</span>
<span>  path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  fluxnet_format <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  out_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="plotting-conversion-results">Plotting conversion results<a class="anchor" aria-label="anchor" href="#plotting-conversion-results"></a>
</h4>
<p>You can plot conversion results to quickly inspect the results. Here
we retain the data in its original FLUXNET formatting and output the
gapfilled and amended data as a data frame. This data frame is input to
the plotting routine <code>fdk_plot</code>, which returns an overview
plot to the specified <code>out_path</code> directory.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read in and convert the data</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fdk_convert_lsm.html">fdk_convert_lsm</a></span><span class="op">(</span></span>
<span>  site <span class="op">=</span> <span class="st">"FR-Fon"</span>,</span>
<span>  path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  fluxnet_format <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot the returned data frame</span></span>
<span><span class="co"># as a file</span></span>
<span><span class="fu"><a href="../reference/fdk_plot.html">fdk_plot</a></span><span class="op">(</span></span>
<span>  <span class="va">df</span>,</span>
<span>  site <span class="op">=</span> <span class="st">"FR-Fon"</span>, <span class="co"># for writing things to file</span></span>
<span>  out_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="conversions-to-daily-fluxnet-data-downsampling">Conversions to daily FLUXNET data (downsampling)<a class="anchor" aria-label="anchor" href="#conversions-to-daily-fluxnet-data-downsampling"></a>
</h3>
<p>Fluxnet data processed to netcdf files can be converted back to
FLUXNET CSV based files, with the same column naming conventions as the
original files. Data however is downsampled to a daily time step, and
additional variables and gap filling is retained from the above LSM
based product.</p>
<p>It must be noted that the these daily products, although adhering to
the FLUXNET naming conventions (both in filename and column names), are
not equivalent to the data generated by the OneFlux processing
pipeline.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Downsample data</span></span>
<span><span class="fu"><a href="../reference/fdk_downsample_fluxnet.html">fdk_downsample_fluxnet</a></span><span class="op">(</span></span>
<span>  <span class="va">df</span>,</span>
<span>  site <span class="op">=</span> <span class="st">"FR-Fon"</span>, <span class="co"># a site name</span></span>
<span>  out_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="p-model-rsofun-and-machine-learning-formatting">p-model (rsofun) and Machine Learning formatting<a class="anchor" aria-label="anchor" href="#p-model-rsofun-and-machine-learning-formatting"></a>
</h3>
<p>In addition, MODIS data can be merged from the FluxnetEO dataset
using the R package <a href="https://github.com/computationales/FluxnetEO" class="external-link">with the same
name</a>. The latter ensures that rsofun driver (and target) data are
ammended with MODIS data for, among others, machine learning
projects.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">rsofun</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># processing of the half hourly data to</span></span>
<span><span class="co"># p-model input drivers for rsofun</span></span>
<span><span class="va">rsofun_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fdk_format_drivers.html">fdk_format_drivers</a></span><span class="op">(</span></span>
<span>  site_info <span class="op">=</span> <span class="fu">FluxDataKit</span><span class="fu">::</span><span class="va"><a href="../reference/fdk_site_info.html">fdk_site_info</a></span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sitename</span> <span class="op">==</span> <span class="st">"FR-Fon"</span><span class="op">)</span>,</span>
<span>  path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>,<span class="st">"/"</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># optimized parameters from previous work</span></span>
<span><span class="va">params_modl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  kphio           <span class="op">=</span> <span class="fl">0.09423773</span>,</span>
<span>  soilm_par_a     <span class="op">=</span> <span class="fl">0.33349283</span>,</span>
<span>  soilm_par_b     <span class="op">=</span> <span class="fl">1.45602286</span>,</span>
<span>  tau_acclim_tempstress <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  par_shape_tempstress  <span class="op">=</span> <span class="fl">0.0</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># run the model for these parameters</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="fu">runread_pmodel_f</span><span class="op">(</span></span>
<span>  <span class="va">rsofun_data</span>,</span>
<span>  par <span class="op">=</span> <span class="va">params_modl</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we only have one site so we'll unnest</span></span>
<span><span class="co"># the main model output</span></span>
<span><span class="va">model_data</span> <span class="op">&lt;-</span> <span class="va">output</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">model_data</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">validation_data</span> <span class="op">&lt;-</span> <span class="va">rsofun_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sitename</span> <span class="op">==</span> <span class="st">"FR-Fon"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">forcing</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">model_data</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span></span>
<span>      <span class="va">date</span>,</span>
<span>      <span class="va">gpp</span></span>
<span>    <span class="op">)</span>,</span>
<span>    colour <span class="op">=</span> <span class="st">"red"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">validation_data</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span></span>
<span>      <span class="va">date</span>,</span>
<span>      <span class="va">gpp</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Date"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"GPP"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre></div>
<p><img src="https://github.com/computationales/FluxDataKit/raw/main/demo.png"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start bottom-8">
            <div class="col-xs-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/computationales" target="_blank" class="external-link">
                          <div class="icon fab fa-github"></div></a>
                        <a href="https://computationales.ethz.ch/" target="_blank" class="external-link">
                          <div class="icon fa fa-flask"></div></a>
                        <a href="http://twitter.com/SteniBocker/" target="_blank" class="external-link">
                          <div class="icon fab fa-twitter"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://computationales.ethz.ch/" class="external-link">Computationales</a></li>
                            <li><a href="https://computationales.ethz.ch/" class="external-link">Our Team</a></li>
                            <li><a href="https://computationales.ethz.ch/" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://github.com/computationales" class="external-link">Packages</a></li>
                            <li><a href="https://computationales.ethz.ch/" class="external-link">Publications</a></li>
                            <li><a href="https://computationales.ethz.ch/" class="external-link">Blog</a></li>
                        </ul>
</div>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->

      </footer>
</div>

  


  

  </body>
</html>
